<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RuChat">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    <meta name="msapplication-TileColor" content="#0f172a">
    <meta name="application-name" content="RuChat Messenger">
    <meta name="description" content="RuChat - современный мессенджер с видеосообщениями">
    <meta name="keywords" content="мессенджер, чат, RuChat, сообщения, общение, видеосообщения">
    
    <title>RuChat | Современный мессенджер</title>
    
    <!-- Иконки без файлов (встроенные SVG) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%230088cc%22>💬</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%230088cc%22>💬</text></svg>">
    
    <!-- Шрифт -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- Стили -->
    <link rel="stylesheet" href="css/style.css?v=20260223">
    
    <style>
        /* Дополнительные стили для мобильных устройств */
        @media (max-width: 768px) {
            html, body {
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
                overflow: hidden;
                height: 100dvh;
                width: 100%;
                position: relative;
            }
            
            input, textarea {
                -webkit-user-select: text;
                user-select: text;
            }
            
            /* Фикс для меню на мобильных */
            .attachment-menu,
            .record-type-menu,
            .emoji-picker {
                position: fixed !important;
                bottom: 80px !important;
                z-index: 9999 !important;
                max-height: 60vh;
                overflow-y: auto;
            }
            
            .attachment-menu {
                left: 10px !important;
                right: auto !important;
            }
            
            .record-type-menu {
                right: 10px !important;
                left: auto !important;
            }
            
            .emoji-picker {
                left: 10px !important;
                right: 10px !important;
                width: calc(100% - 20px) !important;
            }
        }
    </style>
</head>
<body>

<!-- ==========  ЛОГИН / РЕГИСТРАЦИЯ  ========== -->
<div class="auth-page" id="login">
    <div class="auth-bg" aria-hidden="true"></div>
    <div class="auth-card" role="region" aria-label="Авторизация">
        <div class="auth-title" id="authTitle">SIGN IN</div>

        <label class="auth-label" for="usernameInput">USERNAME</label>
        <input type="text" id="usernameInput" class="auth-input" placeholder="Введите имя" autocomplete="username" inputmode="text" spellcheck="false" lang="ru">

        <label class="auth-label" for="passwordInput">PASSWORD</label>
        <input type="password" id="passwordInput" class="auth-input" placeholder="Введите пароль" autocomplete="current-password">

        <label class="auth-keep">
            <input type="checkbox" id="keepSignedIn">
            <span>Keep me Signed in</span>
        </label>

        <button class="auth-btn" id="authSubmitBtn" type="button">SIGN IN</button>

        <button class="auth-link" id="authForgotBtn" type="button" onclick="recoverPassword()">Forgot password?</button>

        <div class="auth-switch">
            <span id="authSwitchText">New member?</span>
            <button class="auth-switch-link" id="authSwitchLink" type="button" onclick="toggleAuthMode()">Register</button>
        </div>
    </div>
</div>

<!-- ==========  ОСНОВНОЙ ИНТЕРФЕЙС  ========== -->
<div class="main-container" id="main">

    <!-- мобильный хедер -->
    <div class="mobile-header" id="mobileHeader">
        <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="handleMobileMenuButton()">⚙️</button>
        <div class="chat-info">
            <div class="chat-title" id="mobileChatTitle">RuChat</div>
            <div class="mobile-chat-meta">
                <img id="mobileChatAvatar" class="mobile-chat-avatar" alt="Chat Avatar" style="display:none">
                <div class="chat-members" id="mobileChatStatus">Выберите чат</div>
            </div>
        </div>
        <div class="mobile-actions">
            <button class="mobile-call-btn" id="mobileCallBtn" onclick="startVoiceCall()" title="Голосовой звонок">📞</button>
            <button class="mobile-back-btn" id="mobileBackBtn" onclick="closeChat()">←</button>
        </div>
    </div>

    <!-- сайдбар -->
    <div class="sidebar" id="sidebar">
        <!-- Topbar как на референсе: бургер + поиск + аватар -->
        <div class="sidebar-topbar">
            <button class="sidebar-menu-btn" onclick="showSettingsMenu()" title="Меню">☰</button>
            <div class="sidebar-search">
                <span class="sidebar-search-icon">🔍</span>
                <input type="text" class="sidebar-search-input" placeholder="Search" id="searchInput" oninput="searchChats(this.value)">
            </div>
            <img src="" alt="Me" class="sidebar-self-avatar" id="userAvatarTop" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=User&background=0088cc&color=fff&size=36'">
        </div>

        <!-- Скрытые мета-элементы (их читает/обновляет JS) -->
        <div class="user-header user-header-hidden">
            <img src="" alt="Avatar" class="user-avatar" id="userAvatar" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=User&background=0088cc&color=fff&size=44'">
            <div class="user-info">
                <div class="user-name" id="userName"></div>
                <div class="user-status" id="userStatus">В сети</div>
            </div>
        </div>

        <div class="menu-section sidebar-section-hidden">
            <div class="menu-title">Заявки в друзья</div>
            <div class="requests-list" id="friendRequestsList"></div>
        </div>

        <div class="sidebar-chats">
            <div class="contacts-list" id="friendList"></div>
            <div class="groups-list" id="groupList"></div>
        </div>

        <div class="menu-section sidebar-actions">
            <button class="sidebar-action-btn" onclick="showAddFriend()" title="Добавить друга">➕👤</button>
            <button class="sidebar-action-btn" onclick="showCreateGroupModal()" title="Создать группу">➕👥</button>
        </div>

        <div class="menu-section sidebar-section-hidden">
            <div class="menu-title">Заблокированные</div>
            <div class="blocked-list" id="blockedList"></div>
        </div>
    </div>

    <!-- чат -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header" id="chatHeader">
            <div class="chat-info">
                <img src="" alt="" class="user-avatar" id="chatAvatar" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=Chat&background=0088cc&color=fff&size=44'">
                <div>
                    <div class="chat-title" id="chatWith">Выберите чат</div>
                    <div class="chat-members" id="chatMembers"></div>
                </div>
            </div>
            <div class="chat-actions">
                <button class="icon-btn" onclick="toggleMessageSearch()" title="Поиск в чате">🔍</button>
                <button class="icon-btn" onclick="openMediaLibrary()" title="Медиа">🗂</button>
                <button class="icon-btn" onclick="toggleTheme()" title="Сменить тему">🌙</button>
                <button class="icon-btn" onclick="showChatInfo()" title="Информация о чате">№️</button>
                <button class="icon-btn" onclick="toggleEmojiPicker()" title="Эмодзи">😊</button>
            </div>
        </div>
        <div class="chat-search" id="chatSearch">
            <input type="text" id="chatSearchInput" placeholder="Поиск в чате..." oninput="searchMessages(this.value)">
            <span class="chat-search-count" id="chatSearchCount"></span>
            <button class="icon-btn" onclick="clearMessageSearch()" title="Очистить">✕</button>
        </div>

        <!-- ===== ЗАКРЕПЛЕННОЕ СООБЩЕНИЕ ===== -->
        <div class="pinned-bar" id="pinnedBar" style="display:none;" onclick="jumpToPinnedMessage()">
            <div class="pinned-icon">📌</div>
            <div class="pinned-text">
                <div class="pinned-title">Закреплено</div>
                <div class="pinned-preview" id="pinnedPreview"></div>
            </div>
            <button class="pinned-close" onclick="event.stopPropagation(); unpinCurrentChatMessage()" title="Открепить">✕</button>
        </div>

        <div class="stories-container" id="storiesContainer">
            <div class="stories-list" id="storiesList"></div>
        </div>

        <div class="messages-container" id="messages"></div>

        <div class="message-input-container">
            <div class="edit-bar" id="editBar">
                <div class="edit-content" id="editContent">Редактирование сообщения</div>
                <button class="icon-btn edit-close" onclick="clearEdit()" title="Отменить">✕</button>
            </div>
            <div class="reply-bar" id="replyBar">
                <div class="reply-content" id="replyContent"></div>
                <button class="icon-btn reply-close" onclick="clearReply()" title="Отменить">✕</button>
            </div>
            <div class="input-wrapper">
                <button class="attachment-btn" onclick="toggleAttachmentMenu()" title="Прикрепить файл">📎</button>
                <input type="text" class="message-input" id="text" placeholder="Введите сообщение..." 
                       onkeypress="handleKeyPress(event)" oninput="updateSendButton(); handleTyping()"
                       autocomplete="off" autocorrect="on" autocapitalize="sentences" lang="ru" dir="auto">
                <button class="icon-btn" onclick="toggleStickerPanel()" title="Стикеры">🧩</button>
                <button class="icon-btn" onclick="showRecordTypeMenu()" title="Запись сообщения">🎤</button>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Отправить">✈️</button>
            </div>
        </div>
    </div>

</div>

<!-- ===== ПАНЕЛЬ ЭМОДЗИ ===== -->
<div class="emoji-picker" id="emojiPicker">
    <div class="emoji-search"><input type="text" placeholder="Поиск эмодзи..." id="emojiSearch"></div>
    <div class="emoji-categories" id="emojiCategories"></div>
    <div class="emoji-grid" id="emojiGrid"></div>
</div>

<!-- ===== МЕНЮ НАСТРОЕК ЧАТА ===== -->
<div class="chat-settings-menu" id="chatSettingsMenu">
    <button class="chat-settings-item" id="groupManageMenuItem" onclick="openGroupAdminPanel()" style="display:none;">Управление группой</button>
    <button class="chat-settings-item" onclick="openChatBackground()">Поменять фон чата</button>
    <button class="chat-settings-item" onclick="openMediaLibrary()">Медиа чата</button>
    <button class="chat-settings-item" onclick="openChatNotifySettings()">Уведомления</button>
    <button class="chat-settings-item" onclick="clearCurrentChat()">Очистить чат</button>
    <button class="chat-settings-item" onclick="toggleMessageSearch()">Поиск в чате</button>
</div>

<!-- ===== УВЕДОМЛЕНИЯ ЧАТА ===== -->
<div class="chat-notify-overlay" id="chatNotifyOverlay" onclick="closeChatNotifySettings()">
    <div class="chat-notify-modal" onclick="event.stopPropagation()">
        <div class="chat-notify-header">
            <div>
                <h2 class="chat-notify-title">Уведомления чата</h2>
                <div class="chat-notify-subtitle" id="chatNotifySubtitle">Чат</div>
            </div>
            <button class="icon-btn" onclick="closeChatNotifySettings()" title="Закрыть">✕</button>
        </div>

        <div class="chat-notify-section">
            <div class="chat-notify-label">Мьют</div>
            <div class="chat-notify-row">
                <button class="chat-notify-btn" onclick="setChatMuteMinutes(0)">Не мьютить</button>
                <button class="chat-notify-btn" onclick="setChatMuteMinutes(60)">1ч</button>
                <button class="chat-notify-btn" onclick="setChatMuteMinutes(480)">8ч</button>
                <button class="chat-notify-btn" onclick="setChatMuteMinutes(2880)">2д</button>
                <button class="chat-notify-btn danger" onclick="setChatMuteForever()">Навсегда</button>
            </div>
            <div class="chat-notify-hint" id="chatMuteHint"></div>
        </div>

        <div class="chat-notify-section">
            <div class="chat-notify-label">Отправка без звука</div>
            <div class="chat-notify-row">
                <button class="chat-notify-btn" id="silentSendBtn" onclick="toggleSilentSendForChat()">Без звука: выкл</button>
            </div>
            <div class="chat-notify-hint">Сообщения будут приходить собеседнику без звука (как в Telegram).</div>
        </div>

        <div class="chat-notify-actions">
            <button class="login-btn" onclick="closeChatNotifySettings()">Закрыть</button>
        </div>
    </div>
</div>

<!-- ===== УПРАВЛЕНИЕ ГРУППОЙ ===== -->
<div class="group-admin-overlay" id="groupAdminOverlay" onclick="closeGroupAdminPanel()">
    <div class="group-admin-modal" onclick="event.stopPropagation()">
        <div class="group-admin-header">
            <div>
                <h2 class="group-admin-title" id="groupAdminTitle">Управление группой</h2>
                <div class="group-admin-subtitle" id="groupAdminSubtitle">Загрузка...</div>
            </div>
            <button class="icon-btn" onclick="closeGroupAdminPanel()" title="Закрыть">✕</button>
        </div>
        <div class="group-admin-list" id="groupAdminList"></div>
        <div class="group-admin-actions">
            <button class="chat-bg-btn secondary" id="leaveGroupBtn" onclick="leaveCurrentGroup()" style="display:none;">Выйти из группы</button>
        </div>
    </div>
</div>

<!-- ===== ПАНЕЛЬ СТИКЕРОВ ===== -->
<div class="sticker-panel" id="stickerPanel">
    <div class="sticker-header">
        <div class="sticker-title">Стикеры</div>
        <button class="icon-btn sticker-close" onclick="toggleStickerPanel()" title="Закрыть">✕</button>
    </div>
    <div class="sticker-grid" id="stickerGrid"></div>
    <div class="sticker-actions">
        <button class="sticker-action-btn" onclick="openStickerBot()">Sticker Bot</button>
    </div>
</div>

<!-- ===== STICKER BOT ===== -->
<div class="sticker-bot-overlay" id="stickerBotOverlay">
    <div class="sticker-bot-modal">
        <h2 class="sticker-bot-title">Sticker Bot</h2>
        <p class="sticker-bot-subtitle">Создай стикер из фото и добавь эмодзи</p>
        <input type="file" id="stickerFileInput" accept="image/*" onchange="handleStickerFileChange(event)">
        <input type="text" id="stickerEmojiInput" placeholder="Эмодзи (необязательно)">
        <div class="sticker-preview-wrap">
            <img id="stickerPreview" alt="Предпросмотр">
        </div>
        <div class="sticker-bot-actions">
            <button class="login-btn" onclick="saveSticker()">Добавить стикер</button>
            <button class="login-btn secondary" onclick="closeStickerBot()">Отмена</button>
        </div>
    </div>
</div>

<!-- ===== МЕДИАТЕКА ЧАТА ===== -->
<div class="media-library-overlay" id="mediaLibraryOverlay" onclick="closeMediaLibrary()">
    <div class="media-library-modal" onclick="event.stopPropagation()">
        <div class="media-library-header">
            <div class="media-library-title">Медиа</div>
            <button class="icon-btn" onclick="closeMediaLibrary()" title="Закрыть">✕</button>
        </div>
        <div class="media-library-tabs">
            <button class="media-tab active" data-tab="photos" onclick="setMediaTab('photos')">Фото</button>
            <button class="media-tab" data-tab="videos" onclick="setMediaTab('videos')">Видео</button>
            <button class="media-tab" data-tab="files" onclick="setMediaTab('files')">Файлы</button>
        </div>
        <div class="media-library-content">
            <div class="media-grid" id="mediaGrid"></div>
            <div class="media-empty" id="mediaEmpty" style="display:none;">Нет файлов в этом чате</div>
        </div>
    </div>
</div>

<!-- ===== ФОН ЧАТА ===== -->
<div class="chat-bg-overlay" id="chatBgOverlay">
    <div class="chat-bg-modal">
        <h2 class="chat-bg-title">Фон чата</h2>
        <p class="chat-bg-subtitle">Выберите готовый фон или загрузите свой</p>
        <div class="chat-bg-grid" id="chatBgGrid">
            <button class="chat-bg-item" data-bg="linear-gradient(135deg,#0f172a,#1e293b)" onclick="selectChatBackground(this)"></button>
            <button class="chat-bg-item" data-bg="linear-gradient(135deg,#0ea5e9,#2563eb)" onclick="selectChatBackground(this)"></button>
            <button class="chat-bg-item" data-bg="linear-gradient(135deg,#9333ea,#4f46e5)" onclick="selectChatBackground(this)"></button>
            <button class="chat-bg-item" data-bg="linear-gradient(135deg,#f59e0b,#ef4444)" onclick="selectChatBackground(this)"></button>
            <button class="chat-bg-item" data-bg="linear-gradient(135deg,#10b981,#14b8a6)" onclick="selectChatBackground(this)"></button>
            <button class="chat-bg-item" data-bg="linear-gradient(135deg,#1f2937,#111827)" onclick="selectChatBackground(this)"></button>
            <button class="chat-bg-item" data-bg="url('https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=800&q=60')" onclick="selectChatBackground(this)"></button>
            <button class="chat-bg-item" data-bg="url('https://images.unsplash.com/photo-1496307653780-42ee777d4833?auto=format&fit=crop&w=800&q=60')" onclick="selectChatBackground(this)"></button>
        </div>
        <div class="chat-bg-upload">
            <input type="file" id="chatBgFileInput" accept="image/*" onchange="handleChatBgFileChange(event)">
            <button class="chat-bg-btn" onclick="saveChatBackground()">Применить</button>
            <button class="chat-bg-btn secondary" onclick="clearChatBackground()">Сбросить</button>
        </div>
        <div class="chat-bg-preview">
            <div class="chat-bg-preview-box" id="chatBgPreviewBox"></div>
        </div>
        <div class="chat-bg-actions">
            <button class="login-btn" onclick="closeChatBackground()">Закрыть</button>
        </div>
    </div>
</div>

<!-- ===== МЕНЮ ПРИКРЕПЛЕНИЯ ===== -->
<div class="attachment-menu" id="attachmentMenu">
    <div class="attachment-item" onclick="attachPhoto()"><div class="icon">📷</div><div class="text">Фото</div></div>
    <div class="attachment-item" onclick="attachVideo()"><div class="icon">🎥</div><div class="text">Видео</div></div>
    <div class="attachment-item" onclick="attachDocument()"><div class="icon">📄</div><div class="text">Документ</div></div>
    <div class="attachment-item" onclick="attachAudio()"><div class="icon">🎵</div><div class="text">Аудио</div></div>
</div>

<!-- ===== МЕНЮ ВЫБОРА ТИПА ЗАПИСИ ===== -->
<div class="attachment-menu record-type-menu" id="recordTypeMenu">
    <div class="attachment-item" onclick="startAudioRecording()">
        <div class="icon">🎤</div>
        <div class="text">Аудиосообщение</div>
    </div>
    <div class="attachment-item" onclick="startVideoRecording()">
        <div class="icon">🎥</div>
        <div class="text">Видеосообщение</div>
    </div>
</div>

<!-- ===== ОВЕРЛЕЙ ЗАПИСИ ВИДЕОСООБЩЕНИЯ ===== -->
<div class="record-overlay video-record-overlay" id="videoRecordOverlay">
    <div class="record-modal video-record-modal">
        <div class="video-preview-container">
            <video class="video-preview" id="videoPreview" autoplay muted></video>
            <div class="recording-indicator" id="recordingIndicator">
                <div class="recording-dot"></div>
                <span>Идет запись...</span>
            </div>
            <div class="record-timer" id="videoTimer">00:00</div>
            <div class="camera-controls">
                <button class="icon-btn" onclick="toggleCamera()" title="Перевернуть камеру">
                    <span class="camera-icon">🔄</span>
                </button>
                <button class="icon-btn" onclick="cancelVideoRecording()" title="Отмена">
                    <span class="cancel-icon">✕</span>
                </button>
            </div>
        </div>
        <div class="record-controls video-record-controls">
            <div class="record-lock" id="videoLockIndicator">
                <div class="lock-icon">🔒</div>
                <div class="lock-text" id="videoLockHint">Потяните вверх, чтобы закрепить</div>
            </div>
            <button class="record-btn video-record-btn" id="videoRecordBtn"
                    onmousedown="startVideoRecordingAction()"
                    ontouchstart="startVideoRecordingAction()"
                    title="Удерживайте для записи">
                <div class="video-record-btn-inner"></div>
            </button>
            <div class="record-hint">Свайп вверх — закрепить, влево — отмена</div>
        </div>
    </div>
</div>

<!-- ===== КНОПКА ЗВОНКА ===== -->
<button class="call-button" id="callButton" onclick="startVoiceCall()" title="Голосовой звонок">📞</button>

<!-- ===== ОВЕРЛЕЙ ЗВОНКА ===== -->
<div class="call-overlay" id="callOverlay">
    <div class="call-modal">
        <div class="call-avatar-wrap">
            <div class="call-ring"></div>
            <img class="call-avatar" id="callAvatar" alt="Call Avatar">
        </div>
        <div class="call-name" id="callName"></div>
        <div class="call-status" id="callStatus"></div>
        <div class="call-timer" id="callTimer">00:00</div>
        <div class="call-controls">
            <button class="call-control-btn" id="muteBtn" onclick="toggleMute()" title="Микрофон">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
            </button>
            <button class="call-control-btn end" onclick="endCall()" title="Завершить">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 14c3-2 6-3 9-3s6 1 9 3"></path>
                    <path d="M5 16v3"></path>
                    <path d="M19 16v3"></path>
                </svg>
            </button>
            <button class="call-control-btn" id="speakerBtn" onclick="toggleSpeaker()" title="Динамик">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 5L6 9H2v6h4l5 4z"></path>
                    <path d="M19 5a7 7 0 0 1 0 14"></path>
                    <path d="M16 8a4 4 0 0 1 0 8"></path>
                </svg>
            </button>
            <button class="call-control-btn" id="deviceBtn" onclick="toggleDeviceSelector()" title="Устройство вывода">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
                    <line x1="12" y1="18" x2="12.01" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="call-device-selector" id="callDeviceSelector" style="display:none;">
            <select id="audioOutputSelect" onchange="changeAudioOutput(this.value)"></select>
        </div>
        <div class="call-incoming-controls" id="callIncomingControls">
            <button class="call-action-btn accept" onclick="acceptIncomingCallFromUI()">Принять</button>
            <button class="call-action-btn reject" onclick="rejectIncomingCallFromUI()">Отклонить</button>
        </div>
    </div>
</div>

<!-- ===== ОВЕРЛЕЙ ЗАПИСИ ГОЛОСОВОГО ===== -->
<div class="record-overlay voice-record-overlay" id="voiceRecordOverlay">
    <div class="record-modal voice-record-modal">
        <div class="voice-record-top">
            <div class="voice-record-label">Голосовое сообщение</div>
            <div class="record-timer" id="voiceTimer">00:00</div>
        </div>
        <div class="voice-waveform" id="voiceWaveform">
            <div class="waveform-line" style="left:10%"></div>
            <div class="waveform-line" style="left:20%"></div>
            <div class="waveform-line" style="left:30%"></div>
            <div class="waveform-line" style="left:40%"></div>
            <div class="waveform-line" style="left:50%"></div>
            <div class="waveform-line" style="left:60%"></div>
            <div class="waveform-line" style="left:70%"></div>
            <div class="waveform-line" style="left:80%"></div>
            <div class="waveform-line" style="left:90%"></div>
        </div>
        <div class="voice-record-bar">
            <button class="voice-cancel-btn" onclick="cancelVoiceRecord()">Отмена</button>
            <div class="voice-record-center">
            <button class="record-btn start" id="voiceStartBtn" title="Удерживайте для записи">●</button>
            <button class="record-btn stop" onclick="stopVoiceRecord()" id="voiceStopBtn" style="display:none" title="Остановить запись">■</button>
            <div class="voice-record-hint">Свайп вверх — закрепить, влево — отмена</div>
            </div>
            <div class="voice-lock-pill">🔒</div>
        </div>
    </div>
</div>

<!-- ===== ОВЕРЛЕЙ СОЗДАНИЯ ГРУППЫ ===== -->
<div class="group-modal-overlay" id="groupModalOverlay">
    <div class="group-modal">
        <h2 class="group-modal-title">Создать группу</h2>
        <input type="text" class="group-input" id="groupNameInput" placeholder="Название группы">
        <input type="text" class="group-input" id="groupAvatarInput" placeholder="Ссылка на аватар (необязательно)">
        <div class="group-members-list" id="groupMembersList"></div>
        <div class="group-modal-buttons">
            <button class="login-btn" onclick="createGroup()">Создать</button>
            <button class="login-btn secondary" onclick="closeGroupModal()">Отмена</button>
        </div>
    </div>
</div>

<!-- ===== УВЕДОМЛЕНИЕ ===== -->
<div class="notification" id="notification">
    <div class="notification-icon">🔔</div>
    <div class="notification-content">
        <div class="notification-title" id="notificationTitle"></div>
        <div class="notification-text" id="notificationText"></div>
    </div>
</div>

<!-- ===== ЗАГРУЗКА ===== -->
<div class="loading-overlay" id="loadingOverlay" style="display:none;">
    <div class="loading-spinner"></div>
    <div class="loading-text">Загрузка...</div>
</div>

<!-- Скрипты -->
<script src="js/firebase-config.js?v=20260219d"></script>
<script src="js/utils.js?v=20260224a"></script> <!-- ПЕРВЫЙ! Содержит глобальные переменные -->
<script src="js/main.js?v=20260219d"></script>
<script src="js/ui.js?v=20260219d"></script>
<script src="js/sounds.js?v=20260219d"></script>
<script src="js/auth.js?v=20260219d"></script>
<script src="js/status.js?v=20260219d"></script>
<script src="js/chat.js?v=20260219d"></script>
<script src="js/media.js?v=20260219d"></script>
<script src="js/emoji.js?v=20260224a"></script>
<script src="js/stickers.js?v=20260219d"></script>
<script src="js/groups.js?v=20260219d"></script>
<script src="js/mobile.js?v=20260219d"></script>
<script src="js/video-messages.js?v=20260224a"></script>
<script src="js/audio-call.js?v=20260224i"></script>
<script src="js/settings.js?v=20260219d"></script>

<script>
    // Функция для проверки локального запуска
    window.isLocalFile = function() {
        return window.location.protocol === 'file:';
    };

    console.log('Build 2026-02-24i (исправлен конфликт звонков)');
    
    // Автоматическое скрытие меню при клике вне их
    document.addEventListener('click', function(e) {
        const attachmentMenu = document.getElementById('attachmentMenu');
        const recordTypeMenu = document.getElementById('recordTypeMenu');
        const emojiPicker = document.getElementById('emojiPicker');
        const stickerPanel = document.getElementById('stickerPanel');
        const chatSettingsMenu = document.getElementById('chatSettingsMenu');
        const chatBgOverlay = document.getElementById('chatBgOverlay');
        
        if (attachmentMenu && attachmentMenu.classList.contains('active') && 
            !e.target.closest('.attachment-menu') && 
            !e.target.closest('.attachment-btn')) {
            attachmentMenu.classList.remove('active');
        }
        
        if (recordTypeMenu && recordTypeMenu.classList.contains('active') && 
            !e.target.closest('.record-type-menu') && 
            !e.target.closest('.icon-btn[onclick*="showRecordTypeMenu"]')) {
            recordTypeMenu.classList.remove('active');
        }
        
        if (emojiPicker && emojiPicker.classList.contains('active') && 
            !e.target.closest('.emoji-picker') && 
            !e.target.closest('.icon-btn[onclick*="toggleEmojiPicker"]')) {
            emojiPicker.classList.remove('active');
        }
        
        if (stickerPanel && stickerPanel.classList.contains('active') &&
            !e.target.closest('.sticker-panel') &&
            !e.target.closest('.icon-btn[onclick*="toggleStickerPanel"]')) {
            stickerPanel.classList.remove('active');
        }
        
        if (chatSettingsMenu && chatSettingsMenu.classList.contains('active') &&
            !e.target.closest('.chat-settings-menu') &&
            !e.target.closest('#mobileMenuBtn')) {
            chatSettingsMenu.classList.remove('active');
        }
        if (chatBgOverlay && chatBgOverlay.classList.contains('active') &&
            e.target === chatBgOverlay) {
            chatBgOverlay.classList.remove('active');
        }
    });

    // Автоматическое обновление isMobile при изменении размера окна
    window.addEventListener('resize', function() {
        window.isMobile = window.innerWidth <= 768;
    });
</script>

</body>
</html>










