# üìû –ó–≤–æ–Ω–∫–∏ –≤ RuChat - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ SDP offer/answer** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `currentRemoteDescription` –≤–º–µ—Å—Ç–æ `remoteDescription`
2. **ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –ø—Ä–∏—Ö–æ–¥–∏–ª–∏ –¥–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ remote description** - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫** - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ª–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ WebRTC
4. **–£—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏** - —É–ª—É—á—à–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–≤–æ–Ω–∫–∞

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ–¥–µ:

#### 1. –û—á–µ—Ä–µ–¥—å ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
```javascript
let iceCandidateQueue = [];

// –ö–∞–Ω–¥–∏–¥–∞—Ç—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å, –µ—Å–ª–∏ remote description –µ—â—ë –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
if (!peerConnection.remoteDescription) {
    iceCandidateQueue.push(c);
} else {
    await peerConnection.addIceCandidate(new RTCIceCandidate(c));
}

// –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ remote description –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å
async function processIceCandidateQueue() {
    for (const candidate of iceCandidateQueue) {
        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
    }
    iceCandidateQueue = [];
}
```

#### 2. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ remote description
```javascript
// –î–ª—è –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
await peerConnection.setRemoteDescription(new RTCSessionDescription(callData.offer));
const answer = await peerConnection.createAnswer();
await peerConnection.setLocalDescription(answer);

// –î–ª—è –∏—Å—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
const offer = await peerConnection.createOffer();
await peerConnection.setLocalDescription(offer);
// –ñ–¥—ë–º answer –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
```

#### 3. –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π
```javascript
peerConnection.onconnectionstatechange = () => {
    console.log('–°–æ—Å—Ç–æ—è–Ω–∏–µ:', peerConnection.connectionState);
    if (peerConnection.connectionState === 'failed') {
        endCall();
    } else if (peerConnection.connectionState === 'connected') {
        document.getElementById('callStatus').textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–æ';
    }
};
```

#### 4. –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
```javascript
async function endCall() {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º peer connection
    // –û—Ç–∫–ª—é—á–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ Firebase
    // –û—á–∏—â–∞–µ–º –æ—á–µ—Ä–µ–¥—å ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ Firebase
}
```

## üß™ –ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–≤–æ–Ω–∫–∏

### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞:
1. –û—Ç–∫—Ä–æ–π—Ç–µ RuChat –≤ **–¥–≤—É—Ö —Ä–∞–∑–Ω—ã—Ö –≤–∫–ª–∞–¥–∫–∞—Ö** –±—Ä–∞—É–∑–µ—Ä–∞
2. –í–æ–π–¥–∏—Ç–µ –ø–æ–¥ **—Ä–∞–∑–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `user1` –∏ `user2`)
3. –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥ –¥—Ä—É–≥–∞ –≤ –¥—Ä—É–∑—å—è

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞:
1. –í –ø–µ—Ä–≤–æ–π –≤–∫–ª–∞–¥–∫–µ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å `user2`
2. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É üìû (–∑–≤–æ–Ω–æ–∫)
3. –î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è –æ–∫–Ω–æ "–ó–≤–æ–Ω–∏–º..."
4. –í–æ –≤—Ç–æ—Ä–æ–π –≤–∫–ª–∞–¥–∫–µ –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è –æ–∫–Ω–æ "–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç user1"
5. –ù–∞–∂–º–∏—Ç–µ "–ü—Ä–∏–Ω—è—Ç—å" –≤–æ –≤—Ç–æ—Ä–æ–π –≤–∫–ª–∞–¥–∫–µ
6. –ü–æ—Å–ª–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∞—Ç—å –æ—Ç—Å—á–∏—Ç—ã–≤–∞—Ç—å –≤—Ä–µ–º—è
7. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–ª—ã—à–∏—Ç–µ –∑–≤—É–∫ (–µ—Å–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—ã —Ä–∞–±–æ—Ç–∞—é—Ç)

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞:
1. –í–æ –≤—Ç–æ—Ä–æ–π –≤–∫–ª–∞–¥–∫–µ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å `user1`
2. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É üìû
3. –í –ø–µ—Ä–≤–æ–π –≤–∫–ª–∞–¥–∫–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–π—Ç–∏ –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
4. –ù–∞–∂–º–∏—Ç–µ "–ü—Ä–∏–Ω—è—Ç—å"

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π –≤–æ –≤—Ä–µ–º—è –∑–≤–æ–Ω–∫–∞:
- **–ú–∏–∫—Ä–æ—Ñ–æ–Ω** - –∫–Ω–æ–ø–∫–∞ üîá –¥–æ–ª–∂–Ω–∞ –≤–∫–ª—é—á–∞—Ç—å/–≤—ã–∫–ª—é—á–∞—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω
- **–î–∏–Ω–∞–º–∏–∫** - –∫–Ω–æ–ø–∫–∞ üîà –¥–æ–ª–∂–Ω–∞ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å
- **–ó–∞–≤–µ—Ä—à–∏—Ç—å** - –∫–Ω–æ–ø–∫–∞ üî¥ –¥–æ–ª–∂–Ω–∞ –∑–∞–≤–µ—Ä—à–∞—Ç—å –∑–≤–æ–Ω–æ–∫

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞:
1. –ù–∞—á–Ω–∏—Ç–µ –∑–≤–æ–Ω–æ–∫ –∏–∑ –ø–µ—Ä–≤–æ–π –≤–∫–ª–∞–¥–∫–∏
2. –í–æ –≤—Ç–æ—Ä–æ–π –≤–∫–ª–∞–¥–∫–µ –Ω–∞–∂–º–∏—Ç–µ "–û—Ç–∫–ª–æ–Ω–∏—Ç—å"
3. –í –ø–µ—Ä–≤–æ–π –≤–∫–ª–∞–¥–∫–µ –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ "–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –æ—Ç–∫–ª–æ–Ω–∏–ª –∑–≤–æ–Ω–æ–∫"

## üîç –û—Ç–ª–∞–¥–∫–∞

### –í–∫–ª—é—á–µ–Ω–∏–µ –ª–æ–≥–æ–≤:
–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (F12) –∏ –Ω–∞–±–ª—é–¥–∞–π—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏:
```
Audio call module loaded
–°–ª—É—à–∞–µ–º –≤—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏ –¥–ª—è: user1
–°–ª—É—à–∞—Ç–µ–ª—å –≤—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç: user2 callId: -abc123...
–ü—Ä–∏–Ω–∏–º–∞–µ–º –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç: user2
Remote offer —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
Local answer —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
Answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Firebase
–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ç—Ä–µ–∫
–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: connected
```

### –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è:

| –ü—Ä–æ–±–ª–µ–º–∞ | –†–µ—à–µ–Ω–∏–µ |
|----------|---------|
| "WebRTC –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è" | –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome/Firefox/Edge |
| "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É" | –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –±—Ä–∞—É–∑–µ—Ä–µ |
| "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å" | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç, STUN —Å–µ—Ä–≤–µ—Ä—ã |
| –ó–≤–æ–Ω–æ–∫ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–ª—É—à–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω |
| –ù–µ—Ç –∑–≤—É–∫–∞ | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≥—Ä–æ–º–∫–æ—Å—Ç—å, –º–∏–∫—Ä–æ—Ñ–æ–Ω |

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ STUN/TURN —Å–µ—Ä–≤–µ—Ä–æ–≤

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è Google STUN:
```javascript
const rtcConfiguration = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        { urls: 'stun:stun3.l.google.com:19302' }
    ]
};
```

–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –¥–æ–±–∞–≤—å—Ç–µ TURN —Å–µ—Ä–≤–µ—Ä—ã:
```javascript
{
    urls: 'turn:your-turn-server.com',
    username: 'user',
    credential: 'pass'
}
```

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤

–ü–æ—Å–ª–µ –∑–≤–æ–Ω–∫–∞ –≤ Firebase –æ—Å—Ç–∞—ë—Ç—Å—è –∑–∞–ø–∏—Å—å:
```json
{
    "calls": {
        "-abc123...": {
            "from": "user1",
            "to": "user2",
            "status": "ended",
            "timestamp": 1234567890,
            "endTime": 1234567950,
            "offer": {...},
            "answer": {...}
        }
    }
}
```

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞

- [ ] –ö–Ω–æ–ø–∫–∞ –∑–≤–æ–Ω–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ (–Ω–µ –≤ –≥—Ä—É–ø–ø–µ)
- [ ] –ó–∞–ø—Ä–æ—à–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
- [ ] PeerConnection —Å–æ–∑–¥–∞–Ω
- [ ] Offer/Answer –æ–±–º–µ–Ω –ø—Ä–æ—à—ë–ª —É—Å–ø–µ—à–Ω–æ
- [ ] ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã exchanged
- [ ] –°–æ—Å—Ç–æ—è–Ω–∏–µ changed –Ω–∞ "connected"
- [ ] –¢–∞–π–º–µ—Ä –∏–¥—ë—Ç
- [ ] –ê—É–¥–∏–æ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è

## üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–¢–æ–ª—å–∫–æ 1-–Ω–∞-1** - –≥—Ä—É–ø–ø–æ–≤—ã–µ –∑–≤–æ–Ω–∫–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è
2. **–¢–æ–ª—å–∫–æ –∞—É–¥–∏–æ** - –≤–∏–¥–µ–æ –∑–≤–æ–Ω–∫–æ–≤ –Ω–µ—Ç
3. **–¢—Ä–µ–±—É–µ—Ç HTTPS** –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ (–¥–ª—è WebRTC)
4. **–ú–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å** –≤ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Å–µ—Ç—è—Ö –±–µ–∑ TURN

---

**–í–µ—Ä—Å–∏—è:** 2026-02-24b
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–∞–±–æ—á–∞—è –≤–µ—Ä—Å–∏—è
