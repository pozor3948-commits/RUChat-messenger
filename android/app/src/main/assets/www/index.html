<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RuChat">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    <meta name="msapplication-TileColor" content="#0f172a">
    <meta name="application-name" content="RuChat Messenger">
    <meta name="description" content="RuChat - современный мессенджер с видеосообщениями">
    <meta name="keywords" content="мессенджер, чат, RuChat, сообщения, общение, видеосообщения">
    <!-- Исправление для Android клавиатуры -->
    <meta name="format-detection" content="telephone=no">

    <title>RuChat | Современный мессенджер</title>
    
    <!-- Иконки без файлов (встроенные SVG) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%230088cc%22>💬</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%230088cc%22>💬</text></svg>">
    
    <!-- Шрифт -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- Стили -->
    <link rel="stylesheet" href="css/style.css?v=20260222b">
    
    <style>
        /* Дополнительные стили для мобильных устройств */
        @media (max-width: 768px) {
            html, body {
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
                overflow: hidden;
                height: 100dvh;
                width: 100%;
                position: relative;
            }

            input, textarea {
                -webkit-user-select: text;
                user-select: text;
                /* Исправление для Android - разрешаем длинное нажатие для копирования/вставки */
                -webkit-touch-callout: default;
            }

            /* Фикс для меню на мобильных */
            .attachment-menu,
            .record-type-menu,
            .emoji-picker {
                position: fixed !important;
                bottom: 80px !important;
                z-index: 9999 !important;
                max-height: 60vh;
                overflow-y: auto;
            }

            .attachment-menu {
                left: 10px !important;
                right: auto !important;
            }

            .record-type-menu {
                right: 10px !important;
                left: auto !important;
            }

            .emoji-picker {
                left: 10px !important;
                right: 10px !important;
                width: calc(100% - 20px) !important;
            }
            
            /* Исправление для Android клавиатуры */
            .auth-input, .message-input, .sidebar-search-input {
                font-size: 16px !important; /* Предотвращает зум на iPhone */
            }
        }
    </style>
</head>
<body>

<!-- ==========  ЛОГИН / РЕГИСТРАЦИЯ  ========== -->
<div class="auth-page" id="login">
    <div class="auth-bg" aria-hidden="true"></div>
    <div class="auth-card" role="region" aria-label="Авторизация">
        <div class="auth-title" id="authTitle">ВХОД</div>

        <label class="auth-label" for="usernameInput">ИМЯ ПОЛЬЗОВАТЕЛЯ</label>
        <input type="text" id="usernameInput" class="auth-input" placeholder="Введите имя" autocomplete="username" inputmode="text" spellcheck="true" autocorrect="on" autocapitalize="none" lang="ru">

        <label class="auth-label" for="passwordInput">ПАРОЛЬ</label>
        <input type="password" id="passwordInput" class="auth-input" placeholder="Введите пароль" autocomplete="current-password" inputmode="text" autocapitalize="none">

        <label class="auth-keep">
            <input type="checkbox" id="keepSignedIn">
            <span>Запомнить меня</span>
        </label>

        <button class="auth-btn" id="authSubmitBtn" type="button">ВХОД</button>

        <button class="auth-link" id="authForgotBtn" type="button" onclick="recoverPassword()">Забыли пароль?</button>

        <!-- ===== АЛЬТЕРНАТИВНЫЕ ВАРИАНТЫ ВХОДА ===== -->
        <div class="auth-divider">
            <span>или войдите через</span>
        </div>

        <div class="auth-social-buttons">
            <button class="social-btn google-btn" type="button" onclick="signInWithGoogle()" title="Войти через Google">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Google
            </button>
            <button class="social-btn phone-btn" type="button" onclick="showPhoneAuthModal()" title="Войти по номеру телефона">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                </svg>
                Телефон
            </button>
        </div>

        <div class="auth-switch">
            <span id="authSwitchText">Нет аккаунта?</span>
            <button class="auth-switch-link" id="authSwitchLink" type="button" onclick="toggleAuthMode()">Зарегистрироваться</button>
        </div>
    </div>
</div>

<!-- ===== МОДАЛЬНОЕ ОКНО ВХОДА ПО ТЕЛЕФОНУ ===== -->
<div class="phone-auth-overlay" id="phoneAuthOverlay" onclick="hidePhoneAuthModal()">
    <div class="phone-auth-modal" onclick="event.stopPropagation()">
        <button class="phone-auth-close" onclick="hidePhoneAuthModal()">✕</button>
        <h2 class="phone-auth-title">Вход по номеру телефона</h2>
        <p class="phone-auth-subtitle">Введите номер телефона для получения SMS с кодом</p>
        
        <div class="phone-auth-form">
            <label class="phone-auth-label">Номер телефона</label>
            <div class="phone-input-wrapper">
                <span class="phone-prefix">+7</span>
                <input type="tel" id="phoneNumberInput" class="phone-auth-input" placeholder="(999) 000-00-00" maxlength="17">
            </div>
            
            <button class="phone-auth-btn" id="sendSmsBtn" type="button" onclick="sendSmsCode()">
                Отправить код
            </button>
            
            <div class="verification-code-section" id="verificationCodeSection" style="display:none;">
                <label class="phone-auth-label">Код из SMS</label>
                <input type="text" id="verificationCodeInput" class="phone-auth-input code-input" placeholder="000000" maxlength="6">
                <button class="phone-auth-btn verify-btn" id="verifyCodeBtn" type="button" onclick="verifySmsCode()">
                    Подтвердить
                </button>
                <button class="phone-auth-link" type="button" onclick="resendSmsCode()">
                    Отправить код повторно
                </button>
            </div>
        </div>
        
        <div class="phone-auth-hint">
            ⚠️ SMS платное согласно тарифам вашего оператора
        </div>
    </div>
</div>

<!-- ==========  ОСНОВНОЙ ИНТЕРФЕЙС  ========== -->
<div class="main-container" id="main">

    <!-- мобильный хедер -->
    <div class="mobile-header" id="mobileHeader">
        <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="handleMobileMenuButton()">⚙️</button>
        <div class="chat-info">
            <div class="chat-title" id="mobileChatTitle">RuChat</div>
            <div class="mobile-chat-meta">
                <img id="mobileChatAvatar" class="mobile-chat-avatar" alt="Chat Avatar" style="display:none">
                <div class="chat-members" id="mobileChatStatus">Выберите чат</div>
            </div>
        </div>
        <div class="mobile-actions">
            <button class="mobile-call-btn" id="mobileCallBtn" onclick="startVoiceCall()" title="Голосовой звонок">📞</button>
            <button class="mobile-back-btn" id="mobileBackBtn" onclick="closeChat()">←</button>
        </div>
    </div>

    <!-- сайдбар -->
    <div class="sidebar" id="sidebar">
        <!-- Topbar как на референсе: бургер + поиск + аватар -->
        <div class="sidebar-topbar">
            <button class="sidebar-menu-btn" onclick="showSettingsMenu()" title="Меню">☰</button>
            <div class="sidebar-search">
                <span class="sidebar-search-icon">🔍</span>
                <input type="text" class="sidebar-search-input" placeholder="Поиск" id="searchInput" oninput="searchChats(this.value)">
            </div>
            <img src="" alt="Я" class="sidebar-self-avatar" id="userAvatarTop" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=User&background=0088cc&color=fff&size=36'">
        </div>

        <!-- Скрытые мета-элементы (их читает/обновляет JS) -->
        <div class="user-header user-header-hidden">
            <img src="" alt="Avatar" class="user-avatar" id="userAvatar" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=User&background=0088cc&color=fff&size=44'">
            <div class="user-info">
                <div class="user-name" id="userName"></div>
                <div class="user-status" id="userStatus">В сети</div>
            </div>
        </div>

        <div class="menu-section sidebar-section-hidden">
            <div class="menu-title">Заявки в друзья</div>
            <div class="requests-list" id="friendRequestsList"></div>
        </div>

        <div class="sidebar-chats">
            <div class="contacts-list" id="friendList"></div>
            <div class="groups-list" id="groupList"></div>
        </div>

        <div class="menu-section sidebar-actions">
            <button class="sidebar-action-btn" onclick="showAddFriend()" title="Добавить друга">➕👤</button>
            <button class="sidebar-action-btn" onclick="showCreateGroupModal()" title="Создать группу">➕👥</button>
        </div>

        <div class="menu-section sidebar-section-hidden">
            <div class="menu-title">Заблокированные</div>
            <div class="blocked-list" id="blockedList"></div>
        </div>
    </div>

    <!-- чат -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header" id="chatHeader">
            <div class="chat-info">
                <img src="" alt="" class="user-avatar" id="chatAvatar" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=Chat&background=0088cc&color=fff&size=44'">
                <div>
                    <div class="chat-title" id="chatWith">Выберите чат</div>
                    <div class="chat-members" id="chatMembers"></div>
                </div>
            </div>
            <div class="chat-actions">
                <button class="icon-btn" onclick="toggleMessageSearch()" title="Поиск в чате">🔍</button>
                <button class="icon-btn" onclick="openMediaLibrary()" title="Медиа">🗂</button>
                <button class="icon-btn" onclick="toggleTheme()" title="Сменить тему">🌙</button>
                <button class="icon-btn" onclick="showChatInfo()" title="Информация о чате">ℹ️</button>
                <button class="icon-btn" onclick="toggleEmojiPicker()" title="Эмодзи">😊</button>
            </div>
        </div>
        <div class="chat-search" id="chatSearch">
            <input type="text" id="chatSearchInput" placeholder="Поиск в чате..." oninput="searchMessages(this.value)">
            <span class="chat-search-count" id="chatSearchCount"></span>
            <button class="icon-btn" onclick="clearMessageSearch()" title="Очистить">✕</button>
        </div>

        <!-- ===== ЗАКРЕПЛЕННОЕ СООБЩЕНИЕ ===== -->
        <div class="pinned-bar" id="pinnedBar" style="display:none;" onclick="jumpToPinnedMessage()">
            <div class="pinned-icon">📌</div>
            <div class="pinned-text">
                <div class="pinned-title">Закреплено</div>
                <div class="pinned-preview" id="pinnedPreview"></div>
            </div>
            <button class="pinned-close" onclick="event.stopPropagation(); unpinCurrentChatMessage()" title="Открепить">✕</button>
        </div>

        <div class="stories-container" id="storiesContainer">
            <div class="stories-list" id="storiesList"></div>
        </div>

        <div class="messages-container" id="messages"></div>

        <div class="message-input-container">
            <div class="edit-bar" id="editBar">
                <div class="edit-content" id="editContent">Редактирование сообщения</div>
                <button class="icon-btn edit-close" onclick="clearEdit()" title="Отменить">✕</button>
            </div>
            <div class="reply-bar" id="replyBar">
                <div class="reply-content" id="replyContent"></div>
                <button class="icon-btn reply-close" onclick="clearReply()" title="Отменить">✕</button>
            </div>
            <div class="input-wrapper">
                <button class="attachment-btn" onclick="toggleAttachmentMenu()" title="Прикрепить файл">📎</button>
                <input type="text" class="message-input" id="text" placeholder="Введите сообщение..."
                       onkeypress="handleKeyPress(event)" oninput="updateSendButton(); handleTyping()"
                       autocomplete="off" autocorrect="on" autocapitalize="sentences" lang="ru" dir="auto">
                <button class="icon-btn" onclick="toggleStickerPanel()" title="Стикеры">🧩</button>
                <button class="icon-btn" onclick="showRecordTypeMenu()" title="Запись сообщения">🎤</button>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Отправить">✈️</button>
            </div>
        </div>
    </div>

</div>

<!-- ===== ПАНЕЛЬ ЭМОДЗИ ===== -->
<div class="emoji-picker" id="emojiPicker">
    <div class="emoji-search"><input type="text" placeholder="Поиск эмодзи..." id="emojiSearch"></div>
    <div class="emoji-categories" id="emojiCategories"></div>
    <div class="emoji-grid" id="emojiGrid"></div>
</div>

<!-- ===== МЕНЮ НАСТРОЕК ЧАТА ===== -->
<div class="chat-settings-menu" id="chatSettingsMenu">
    <button class="chat-settings-item" id="groupManageMenuItem" onclick="openGroupAdminPanel()" style="display:none;">Управление группой</button>
    <button class="chat-settings-item" onclick="openChatBackground()">Поменять фон чата</button>
    <button class="chat-settings-item" onclick="openMediaLibrary()">Медиа чата</button>
    <button class="chat-settings-item" onclick="openChatNotifySettings()">Уведомления</button>
    <button class="chat-settings-item" onclick="clearCurrentChat()">Очистить чат</button>
    <button class="chat-settings-item" onclick="toggleMessageSearch()">Поиск в чате</button>
</div>

<!-- ===== УВЕДОМЛЕНИЯ ЧАТА ===== -->
<div class="chat-notify-overlay" id="chatNotifyOverlay" onclick="closeChatNotifySettings()">
    <div class="chat-notify-modal" onclick="event.stopPropagation()">
        <div class="chat-notify-header">
            <div>
                <h2 class="chat-notify-title">Уведомления чата</h2>
                <div class="chat-notify-subtitle" id="chatNotifySubtitle">Чат</div>
            </div>
            <button class="icon-btn" onclick="closeChatNotifySettings()" title="Закрыть">✕</button>
        </div>

        <div class="chat-notify-section">
            <div class="chat-notify-label">Мьют</div>
            <div class="chat-notify-row">
                <button class="chat-notify-btn" onclick="setChatMuteMinutes(0)">Не мьютить</button>
                <button class="chat-notify-btn" onclick="setChatMuteMinutes(60)">1ч</button>
                <button class="chat-notify-btn" onclick="setChatMuteMinutes(480)">8ч</button>
                <button class="chat-notify-btn" onclick="setChatMuteMinutes(2880)">2д</button>
                <button class="chat-notify-btn danger" onclick="setChatMuteForever()">Навсегда</button>
            </div>
            <div class="chat-notify-hint" id="chatMuteHint"></div>
        </div>

        <div class="chat-notify-section">
            <div class="chat-notify-label">Отправка без звука</div>
            <div class="chat-notify-row">
                <button class="chat-notify-btn" id="silentSendBtn" onclick="toggleSilentSendForChat()">Без звука: выкл</button>
            </div>
            <div class="chat-notify-hint">Сообщения будут приходить собеседнику без звука (как в Telegram).</div>
        </div>

        <div class="chat-notify-actions">
            <button class="login-btn" onclick="closeChatNotifySettings()">Закрыть</button>
        </div>
    </div>
</div>

<!-- ===== УПРАВЛЕНИЕ ГРУППОЙ ===== -->
<div class="group-admin-overlay" id="groupAdminOverlay" onclick="closeGroupAdminPanel()">
    <div class="group-admin-modal" onclick="event.stopPropagation()">
        <div class="group-admin-header">
            <div>
                <h2 class="group-admin-title" id="groupAdminTitle">Управление группой</h2>
                <div class="group-admin-subtitle" id="groupAdminSubtitle">Загрузка...</div>
            </div>
            <button class="icon-btn" onclick="closeGroupAdminPanel()" title="Закрыть">✕</button>
        </div>
        <div class="group-admin-list" id="groupAdminList"></div>
        <div class="group-admin-actions">
            <button class="chat-bg-btn secondary" id="leaveGroupBtn" onclick="leaveCurrentGroup()" style="display:none;">Выйти из группы</button>
        </div>
    </div>
</div>

<!-- ===== ПАНЕЛЬ СТИКЕРОВ ===== -->
<div class="sticker-panel" id="stickerPanel">
    <div class="sticker-header">
        <div class="sticker-title">Стикеры</div>
        <button class="icon-btn sticker-close" onclick="toggleStickerPanel()" title="Закрыть">✕</button>
    </div>
    <div class="sticker-grid" id="stickerGrid"></div>
    <div class="sticker-actions">
        <button class="sticker-action-btn" onclick="openStickerBot()">Бот стикеров</button>
    </div>
</div>

<!-- ===== STICKER BOT ===== -->
<div class="sticker-bot-overlay" id="stickerBotOverlay">
    <div class="sticker-bot-modal">
        <h2 class="sticker-bot-title">Бот стикеров</h2>
        <p class="sticker-bot-subtitle">Создай стикер из фото и добавь эмодзи</p>
        <input type="file" id="stickerFileInput" accept="image/*" onchange="handleStickerFileChange(event)">
        <input type="text" id="stickerEmojiInput" placeholder="Эмодзи (необязательно)">
        <div class="sticker-preview-wrap">
            <img id="stickerPreview" alt="Предпросмотр">
        </div>
        <div class="sticker-bot-actions">
            <button class="login-btn" onclick="saveSticker()">Добавить стикер</button>
            <button class="login-btn secondary" onclick="closeStickerBot()">Отмена</button>
        </div>
    </div>
</div>

<!-- ===== МЕДИАТЕКА ЧАТА ===== -->
<div class="media-library-overlay" id="mediaLibraryOverlay" onclick="closeMediaLibrary()">
    <div class="media-library-modal" onclick="event.stopPropagation()">
        <div class="media-library-header">
            <div class="media-library-title">Медиа</div>
            <button class="icon-btn" onclick="closeMediaLibrary()" title="Закрыть">✕</button>
        </div>
        <div class="media-library-tabs">
            <button class="media-tab active" data-tab="photos" onclick="setMediaTab('photos')">Фото</button>
            <button class="media-tab" data-tab="videos" onclick="setMediaTab('videos')">Видео</button>
            <button class="media-tab" data-tab="files" onclick="setMediaTab('files')">Файлы</button>
        </div>
        <div class="media-library-content">
            <div class="media-grid" id="mediaGrid"></div>
            <div class="media-empty" id="mediaEmpty" style="display:none;">Нет файлов в этом чате</div>
        </div>
    </div>
</div>

<!-- ===== ФОН ЧАТА ===== -->
<div class="chat-bg-overlay" id="chatBgOverlay">
    <div class="chat-bg-modal">
        <h2 class="chat-bg-title">Фон чата</h2>
        <p class="chat-bg-subtitle">Выберите готовый фон или загрузите свой</p>
        <div class="chat-bg-grid" id="chatBgGrid">
            <button class="chat-bg-item" data-bg="linear-gradient(135deg,#0f172a,#1e293b)" onclick="selectChatBackground(this)"></button>
            <button class="chat-bg-item" data-bg="linear-gradient(135deg,#0ea5e9,#2563eb)" onclick="selectChatBackground(this)"></button>
            <button class="chat-bg-item" data-bg="linear-gradient(135deg,#9333ea,#4f46e5)" onclick="selectChatBackground(this)"></button>
            <button class="chat-bg-item" data-bg="linear-gradient(135deg,#f59e0b,#ef4444)" onclick="selectChatBackground(this)"></button>
            <button class="chat-bg-item" data-bg="linear-gradient(135deg,#10b981,#14b8a6)" onclick="selectChatBackground(this)"></button>
            <button class="chat-bg-item" data-bg="linear-gradient(135deg,#1f2937,#111827)" onclick="selectChatBackground(this)"></button>
            <button class="chat-bg-item" data-bg="url('https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=800&q=60')" onclick="selectChatBackground(this)"></button>
            <button class="chat-bg-item" data-bg="url('https://images.unsplash.com/photo-1496307653780-42ee777d4833?auto=format&fit=crop&w=800&q=60')" onclick="selectChatBackground(this)"></button>
        </div>
        <div class="chat-bg-upload">
            <input type="file" id="chatBgFileInput" accept="image/*" onchange="handleChatBgFileChange(event)">
            <button class="chat-bg-btn" onclick="saveChatBackground()">Применить</button>
            <button class="chat-bg-btn secondary" onclick="clearChatBackground()">Сбросить</button>
        </div>
        <div class="chat-bg-preview">
            <div class="chat-bg-preview-box" id="chatBgPreviewBox"></div>
        </div>
        <div class="chat-bg-actions">
            <button class="login-btn" onclick="closeChatBackground()">Закрыть</button>
        </div>
    </div>
</div>

<!-- ===== МЕНЮ ПРИКРЕПЛЕНИЯ ===== -->
<div class="attachment-menu" id="attachmentMenu">
    <div class="attachment-item" onclick="attachPhoto()"><div class="icon">📷</div><div class="text">Фото</div></div>
    <div class="attachment-item" onclick="attachVideo()"><div class="icon">🎥</div><div class="text">Видео</div></div>
    <div class="attachment-item" onclick="attachDocument()"><div class="icon">📄</div><div class="text">Документ</div></div>
    <div class="attachment-item" onclick="attachAudio()"><div class="icon">🎵</div><div class="text">Аудио</div></div>
</div>

<!-- ===== МЕНЮ ВЫБОРА ТИПА ЗАПИСИ ===== -->
<div class="attachment-menu record-type-menu" id="recordTypeMenu">
    <div class="attachment-item" onclick="startAudioRecording()">
        <div class="icon">🎤</div>
        <div class="text">Аудиосообщение</div>
    </div>
    <div class="attachment-item" onclick="startVideoRecording()">
        <div class="icon">🎥</div>
        <div class="text">Видеосообщение</div>
    </div>
</div>

<!-- ===== ОВЕРЛЕЙ ЗАПИСИ ВИДЕОСООБЩЕНИЯ ===== -->
<div class="record-overlay video-record-overlay" id="videoRecordOverlay">
    <div class="record-modal video-record-modal">
        <div class="video-preview-wrapper">
            <video class="video-preview" id="videoPreview" autoplay muted playsinline webkit-playsinline></video>
            <div class="video-preview-overlay">
                <div class="recording-timer" id="videoTimer">00:00</div>
                <button class="camera-switch-btn" id="cameraSwitchBtn" onclick="toggleCamera()" title="Переключить камеру">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 7l-7 5 7 5V7z"></path>
                        <path d="M14 5H3a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h11"></path>
                        <path d="M1 7l7 5-7 5V7z"></path>
                        <path d="M10 19H21a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H10"></path>
                    </svg>
                </button>
                <button class="camera-close-btn" onclick="cancelVideoRecording()" title="Закрыть">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
                <div class="recording-indicator" id="recordingIndicator" style="display:none;">
                    <div class="recording-dot"></div>
                </div>
            </div>
        </div>
        <div class="video-record-controls">
            <div class="record-lock" id="videoLockIndicator">
                <div class="lock-icon">🔒</div>
                <div class="lock-text" id="videoLockHint">Потяните вверх, чтобы закрепить</div>
            </div>
            <button class="video-record-circle-btn" id="videoRecordBtn"
                    onmousedown="startVideoRecordingAction()"
                    ontouchstart="startVideoRecordingAction()"
                    title="Удерживайте для записи">
                <div class="video-record-circle-inner"></div>
            </button>
            <div class="record-hint">Свайп вверх — закрепить, влево — отмена</div>
        </div>
    </div>
</div>

<!-- ===== КНОПКА ЗВОНКА ===== -->
<button class="call-button" id="callButton" onclick="startVoiceCall()" title="Голосовой звонок">📞</button>

<!-- ===== ОВЕРЛЕЙ ЗВОНКА ===== -->
<div class="call-overlay" id="callOverlay">
    <div class="call-modal">
        <div class="call-avatar-wrap">
            <div class="call-ring"></div>
            <img class="call-avatar" id="callAvatar" alt="Call Avatar">
        </div>
        <div class="call-name" id="callName"></div>
        <div class="call-status" id="callStatus"></div>
        <div class="call-timer" id="callTimer">00:00</div>
        <div class="call-controls">
            <button class="call-control-btn" id="muteBtn" onclick="toggleMute()" title="Микрофон">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
            </button>
            <button class="call-control-btn end" onclick="endCall()" title="Завершить">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 14c3-2 6-3 9-3s6 1 9 3"></path>
                    <path d="M5 16v3"></path>
                    <path d="M19 16v3"></path>
                </svg>
            </button>
            <button class="call-control-btn" id="speakerBtn" onclick="toggleSpeaker()" title="Динамик">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 5L6 9H2v6h4l5 4z"></path>
                    <path d="M19 5a7 7 0 0 1 0 14"></path>
                    <path d="M16 8a4 4 0 0 1 0 8"></path>
                </svg>
            </button>
        </div>
        <div class="call-incoming-controls" id="callIncomingControls">
            <button class="call-action-btn accept" onclick="acceptIncomingCallFromUI()">Принять</button>
            <button class="call-action-btn reject" onclick="rejectIncomingCallFromUI()">Отклонить</button>
        </div>
    </div>
</div>

<!-- ===== ОВЕРЛЕЙ ЗАПИСИ ГОЛОСОВОГО ===== -->
<div class="record-overlay voice-record-overlay" id="voiceRecordOverlay">
    <div class="voice-record-container">
        <div class="voice-record-header">
            <div class="voice-record-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
            </div>
            <div class="voice-timer-display" id="voiceTimer">00:00</div>
            <div class="voice-status-text">Запись голосового сообщения</div>
        </div>
        
        <div class="voice-visualizer" id="voiceVisualizer">
            <canvas id="voiceCanvas"></canvas>
        </div>
        
        <div class="voice-controls">
            <button class="voice-control-btn cancel" onclick="cancelVoiceRecord()" title="Отменить">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"></path>
                </svg>
            </button>
            
            <div class="voice-record-button-wrapper">
                <button class="voice-record-circle" id="voiceRecordBtn"
                        onmousedown="startVoiceRecordAction()"
                        ontouchstart="startVoiceRecordAction()"
                        onmouseup="stopVoiceRecordAction()"
                        ontouchend="stopVoiceRecordAction()"
                        title="Удерживайте для записи">
                    <div class="voice-record-circle-inner"></div>
                </button>
                <div class="voice-lock-indicator" id="voiceLockIndicator">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    <span>Запись закреплена</span>
                </div>
            </div>
            
            <button class="voice-control-btn send" id="voiceSendBtn" style="display:none;" onclick="sendVoiceRecord()" title="Отправить">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
        
        <div class="voice-hint">Удерживайте для записи • Свайп вверх — закрепить</div>
    </div>
</div>

<!-- ===== ОВЕРЛЕЙ СОЗДАНИЯ ГРУППЫ ===== -->
<div class="group-modal-overlay" id="groupModalOverlay">
    <div class="group-modal">
        <h2 class="group-modal-title">Создать группу</h2>
        <input type="text" class="group-input" id="groupNameInput" placeholder="Название группы">
        <input type="text" class="group-input" id="groupAvatarInput" placeholder="Ссылка на аватар (необязательно)">
        <div class="group-members-list" id="groupMembersList"></div>
        <div class="group-modal-buttons">
            <button class="login-btn" onclick="createGroup()">Создать</button>
            <button class="login-btn secondary" onclick="closeGroupModal()">Отмена</button>
        </div>
    </div>
</div>

<!-- ===== УВЕДОМЛЕНИЕ ===== -->
<div class="notification" id="notification">
    <div class="notification-icon">🔔</div>
    <div class="notification-content">
        <div class="notification-title" id="notificationTitle"></div>
        <div class="notification-text" id="notificationText"></div>
    </div>
</div>

<!-- ===== ЗАГРУЗКА ===== -->
<div class="loading-overlay" id="loadingOverlay" style="display:none;">
    <div class="loading-spinner"></div>
    <div class="loading-text">Загрузка...</div>
</div>

<!-- Скрипты -->
<script src="js/firebase-config.js?v=20260222a"></script>
<script src="js/auth-alternative.js?v=20260222b"></script>
<script src="js/storage.js?v=20260222a"></script>
<script src="js/utils.js?v=20260219d"></script> <!-- ПЕРВЫЙ! Содержит глобальные переменные -->
<script src="js/encryption.js?v=20260222a"></script>
<script src="js/master-encryption.js?v=20260223a"></script>
<script src="js/main.js?v=20260219d"></script>
<script src="js/ui.js?v=20260219d"></script>
<script src="js/sounds.js?v=20260219d"></script>
<script src="js/auth.js?v=20260219d"></script>
<script src="js/status.js?v=20260222a"></script>
<script src="js/chat.js?v=20260222b"></script>
<script src="js/media.js?v=20260222e"></script>
<script src="js/emoji.js?v=20260219d"></script>
<script src="js/stickers.js?v=20260219d"></script>
<script src="js/groups.js?v=20260219d"></script>
<script src="js/mobile.js?v=20260222a"></script>
<script src="js/video-messages.js?v=20260222c"></script>
<script src="js/audio-call.js?v=20260219d"></script>
<script src="js/settings.js?v=20260219d"></script>

<script>
    // Функция для проверки локального запуска
    window.isLocalFile = function() {
        return window.location.protocol === 'file:';
    };

    // Исправление для Android - обработка ввода русских символов
    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('input[type="text"], textarea');
        
        inputs.forEach(function(input) {
            // Устанавливаем правильный тип ввода для Android
            if (!input.hasAttribute('inputmode')) {
                input.setAttribute('inputmode', 'text');
            }
            
            // Обработка composition events для корректного ввода
            input.addEventListener('compositionstart', function() {
                this.dataset.composing = 'true';
            });
            
            input.addEventListener('compositionend', function() {
                this.dataset.composing = 'false';
            });
        });
        
        // Специальная обработка для поля ввода номера телефона
        const phoneInput = document.getElementById('phoneNumberInput');
        if (phoneInput) {
            phoneInput.setAttribute('autocomplete', 'tel');
            phoneInput.setAttribute('inputmode', 'tel');
        }
    });
    
    // Улучшенные уведомления для локального запуска
    window.showNotification = function(title, text, type = 'info') {
        const n = document.getElementById('notification');
        if (!n) return;
        
        document.getElementById('notificationTitle').textContent = title;
        document.getElementById('notificationText').textContent = text;
        
        // Устанавливаем тип уведомления
        n.className = 'notification';
        if (type === 'error') {
            n.style.background = 'linear-gradient(135deg, rgba(239,68,68,0.95), rgba(220,38,38,0.95))';
            n.style.boxShadow = '0 15px 35px rgba(239,68,68,0.4), 0 5px 15px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.2)';
        } else if (type === 'success') {
            n.style.background = 'linear-gradient(135deg, rgba(34,197,94,0.95), rgba(74,222,128,0.95))';
            n.style.boxShadow = '0 15px 35px rgba(34,197,94,0.4), 0 5px 15px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.2)';
        } else if (type === 'warning') {
            n.style.background = 'linear-gradient(135deg, rgba(245,158,11,0.95), rgba(217,119,6,0.95))';
            n.style.boxShadow = '0 15px 35px rgba(245,158,11,0.4), 0 5px 15px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.2)';
        }
        
        n.style.display = 'flex';
        
        // Автоматическое скрытие
        setTimeout(() => {
            n.style.display = 'none';
            // Сбрасываем стили
            n.style.background = '';
            n.style.boxShadow = '';
        }, 3000);
    };
    
    // Улучшенная функция ошибок
    window.showError = function(msg, retry) {
        showNotification(msg, 'Ошибка', 'error');
        if (retry) window.retryAction = retry;
    };
    
    console.log('Build 2026-02-19d');
    
    // Автоматическое скрытие меню при клике вне их
    document.addEventListener('click', function(e) {
        const attachmentMenu = document.getElementById('attachmentMenu');
        const recordTypeMenu = document.getElementById('recordTypeMenu');
        const emojiPicker = document.getElementById('emojiPicker');
        const stickerPanel = document.getElementById('stickerPanel');
        const chatSettingsMenu = document.getElementById('chatSettingsMenu');
        const chatBgOverlay = document.getElementById('chatBgOverlay');
        
        if (attachmentMenu && attachmentMenu.classList.contains('active') && 
            !e.target.closest('.attachment-menu') && 
            !e.target.closest('.attachment-btn')) {
            attachmentMenu.classList.remove('active');
        }
        
        if (recordTypeMenu && recordTypeMenu.classList.contains('active') && 
            !e.target.closest('.record-type-menu') && 
            !e.target.closest('.icon-btn[onclick*="showRecordTypeMenu"]')) {
            recordTypeMenu.classList.remove('active');
        }
        
        if (emojiPicker && emojiPicker.classList.contains('active') && 
            !e.target.closest('.emoji-picker') && 
            !e.target.closest('.icon-btn[onclick*="toggleEmojiPicker"]')) {
            emojiPicker.classList.remove('active');
        }
        
        if (stickerPanel && stickerPanel.classList.contains('active') &&
            !e.target.closest('.sticker-panel') &&
            !e.target.closest('.icon-btn[onclick*="toggleStickerPanel"]')) {
            stickerPanel.classList.remove('active');
        }
        
        if (chatSettingsMenu && chatSettingsMenu.classList.contains('active') &&
            !e.target.closest('.chat-settings-menu') &&
            !e.target.closest('#mobileMenuBtn')) {
            chatSettingsMenu.classList.remove('active');
        }
        if (chatBgOverlay && chatBgOverlay.classList.contains('active') &&
            e.target === chatBgOverlay) {
            chatBgOverlay.classList.remove('active');
        }
    });

    // Автоматическое обновление isMobile при изменении размера окна
    window.addEventListener('resize', function() {
        window.isMobile = window.innerWidth <= 768;
    });
</script>

</body>
</html>










